---
title: "I Did Something About the Weather"
author: "Adam H Sparks"
date: "24/05/2017"
output: 
  ioslides_presentation:
    widescreen: true
    incremental: true
---

<style>    
pre {
  font-family: 'FiraCode-Retina', 'Courier New', monospace;
  font-size: 18px;
  line-height: 26px;
  padding: 10px 0 10px 60px;
  letter-spacing: -1px;
  margin-bottom: 20px;
  width: 106%;
  left: -60px;
  position: relative;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  /*overflow: hidden;*/
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## About Me

**Currently:** A/Prof Field Crops Pathology @ USQ CCH, Toowoomba, AUS

**Previously:** Plant Disease Management Specialist @ IRRI, Los Baños, PHL

### R packages (on CRAN)

GSODR (Sparks, Hengl and Nelson)  

getCRUCLdata (Sparks)

### R packages (not yet on CRAN)

bomrang (Sparks, Parsonage and Pembleton)

## GSOD Data

The GSOD or [Global Surface Summary of the Day (GSOD)](https://data.noaa.gov/dataset/global-surface-summary-of-the-day-gsod) station locations. US National Centers for Environmental Information, 1901-Present.

```{r, echo=FALSE, message=FALSE}
#devtools::install_github("adamhsparks/GSODR", ref = "devel")
library(ggplot2)
library(GSODR)

utils::data("isd_history", package = "GSODR")
GSOD_stations <- as.data.frame(isd_history)

ggplot(GSOD_stations, aes(x = LON, y = LAT)) +
  geom_point(alpha = 0.1) +
  coord_map() +
  theme_bw()
```

## GSOD data files

A raw data file

```{r, echo=FALSE, message=FALSE}
download.file("ftp://ftp.ncdc.noaa.gov/pub/data/gsod/2017/955510-99999-2017.op.gz", 
              paste0(tempdir(), "/955510-99999-2017.op.gz"))
tbar <- list.files(tempdir(), pattern = ".op.gz$", full.names = TRUE)
(readr::read_table(tbar))
```

## The same data file

Retreived and parsed with GSODR

```{r, echo=FALSE, message=FALSE, quiet=TRUE, results="hide"}
# use this to create the dataframe (but shows progress bar)
tbar <- GSODR::reformat_GSOD(dsn = tempdir())
```

```{r, echo=FALSE}
# use this to display the dataframe (no progress bar)
tbar
```

## data file continued...
```{r, echo=FALSE}
# use this to display the dataframe (no progress bar)
tbar[, 19:36]
```

## Functions in GSODR

-   `get_GSOD()` - queries and transfers files from the FTP server, reformats them and returns a `tibble()` object in R session or saves a file to disk with options for a GeoPackage spatially enabled file or comma separated values (CSV) file,  
-   `reformat_GSOD()` - the workhorse, takes individual station files on the local disk and reformats them, returns a `tibble()` object in R session or saves a file to disk with options for a GeoPackage spatially enabled file or comma separated values (CSV) file,  
-   `nearest_stations()` - returns a `vector()` object containing a list of stations and their metadata that fall within the given radius of a point specified by the user,  
-   `get_station_list()` - downloads the latest station list from the NCEI FTP server and returns a `data.table()` object in R session.

## A Friend Came to me With a Problem

IRRI survey loop in Central Luzon since the 1960s.  http://ricestat.irri.org/fhsd/php/panel.php?page=1&sortBy=title&sortOrder=ascending#

Weather data?

## Use Case: Using GSODR to Retrieve Stations for a Specific Geographic Area

  * retrieving a spatial object of provincial level data;  
  
  * sub-setting this data for the provinces of interest;  
  
  * merging the polygons into one object;  
  
  * finding the centroid of this resulting polygon;  
  
  * using the centroid of the polygon to find stations within 100km of this point;  
  
  * determining which stations provide data for the specified time-period, 1960-2015; and   
  
  * downloading the station files and creating a single CSV file of the data for analysis.  

## Retrieve PHL Provincial Data

```{r, echo=TRUE}
library(raster)
RP0 <- getData(country = "Philippines", level = 0)
RP1 <- getData(country = "Philippines", level = 1)
```

## Select Provinces in Loop Survey

```{r, echo=TRUE}
Central_Luzon <- RP1[RP1@data$NAME_1 == "Pampanga" | 
                     RP1@data$NAME_1 == "Tarlac" |
                     RP1@data$NAME_1 == "Pangasinan" |
                     RP1@data$NAME_1 == "La Union" |
                     RP1@data$NAME_1 == "Nueva Ecija" |
                     RP1@data$NAME_1 == "Bulacan", ]
```

## Simplify the data

`gSimplify()` from _rgeos_ simplifies the data to make the map generation in the next few steps quicker.

```{r, echo=TRUE}
library(rgeos)
RP0 <- gSimplify(RP0, tol = 0.05)
```

## Create an Inset Map

```{r, echo=TRUE}
library(ggplot2)
library(grid)
library(gridExtra)

 # get center coordinates of provinces in Central Luzon
CL_names <- data.frame(coordinates(Central_Luzon))

# add them to the data slot
CL_names$label <- Central_Luzon@data$NAME_1
```

## Main Map
```{r main_map, echo=TRUE}
p1 <- ggplot() + 
  geom_polygon(data = Central_Luzon, aes(x = long, y = lat, group = group),
               colour = "grey10", fill = "#fff7bc") +
  geom_text(data = CL_names, aes(x = X1, y = X2, label = label), size = 2,
            colour = "grey20") +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5)) +
  ggtitle("Central Luzon Provinces Surveyed") +
  coord_map() +
  theme_bw() + 
  xlab("Longitude") + 
  ylab("Latitude")
```

## Inset
```{r inset, echo=TRUE}
p2 <- ggplot() + 
  geom_polygon(data = RP0, aes(long, lat, group = group),
               colour = "grey10", fill = "#fff7bc") +
  coord_map() +
  theme_bw() + 
  labs(x = NULL, y = NULL) +
  geom_rect(aes(xmin = extent(Central_Luzon)[1], xmax = extent(Central_Luzon)[2],
                ymin = extent(Central_Luzon)[3], ymax = extent(Central_Luzon)[4]),
            alpha = 0, colour = "red", size = 0.7, linetype = 1) +
  theme(axis.text.x = element_blank(), axis.text.y = element_blank(),
        axis.ticks = element_blank(), axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.margin = unit(c(0, 0, 0 ,0), "mm"))
```

## Put the Maps Together
```{r plot_final_maps, echo=TRUE}
grid.newpage()
v1 <- viewport(width = 1, height = 1, x = 0.5, y = 0.5) # main map
v2 <- viewport(width = 0.28, height = 0.28, x = 0.64, y = 0.76) # inset map
print(p1, vp = v1); print(p2, vp = v2)
```

## Dissolve Polygons and Find Centroid of Loop Survey Area

Now that we have the provincial data that we want, we will dissolve the polygons that represent the individual provinces in Central Luzon and find the centroid of all of them, which we will use as the central point for querying stations from the GSOD data set.

```{r find_centroid, echo=TRUE}
Central_Luzon <- rgeos::gUnaryUnion(Central_Luzon)
centroid <- rgeos::gCentroid(Central_Luzon)
```

## Centroid With Polygons Disolved
```{r plot_centroid, echo=FALSE}
ggplot() + 
  geom_polygon(data = Central_Luzon, aes(x = long, y = lat, group = group),
               colour = "grey10", fill = "#fff7bc") +
  geom_point(aes(x = centroid@coords[1], y = centroid@coords[2])) +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5)) +
  ggtitle("Centre of Survey\nArea") + theme_bw() + 
  xlab("Longitude") + ylab("Latitude") + coord_map()
```

## Create List of Loop Stations
Next, make a list of stations that are within this area. First we need to fetch the station medadata, "isd-history.csv" from the FTP server and then check which stations fall within a 100km radius of the centre of the provinces we're interested in.

```{r get_station_data, echo=TRUE}
library(GSODR)
library(readr)
# Fetch station list from NCEI
station_meta <- read_csv(
  "ftp://ftp.ncdc.noaa.gov/pub/data/noaa/isd-history.csv",
  col_types = "ccccccddddd",
  col_names = c("USAF", "WBAN", "STN_NAME", "CTRY", "STATE", "CALL", "LAT",
                "LON", "ELEV_M", "BEGIN", "END"), skip = 1)
station_meta$STNID <- as.character(paste(station_meta$USAF,
                                         station_meta$WBAN,
                                         sep = "-"))
```

## Loop Stations Continued
```{r find_stations, echo=TRUE}
loop_stations <- nearest_stations(LAT = centroid@coords[2], 
                                  LON = centroid@coords[1], 
                                  distance = 100)

loop_stations <- station_meta[station_meta$STNID %in% loop_stations, ]

loop_stations <- loop_stations[loop_stations$BEGIN <= 19591231 &
                               loop_stations$END >= 20151231, ]
```

## Loop Stations Continued
These are all of the stations that are available within 100km of the centroid of this area and the years for which data are available.

```{r print_stations, echo=TRUE, eval=TRUE}
print(loop_stations[, c(1:2, 3, 7:12)])
```

## Using `get_GSOD()` to Fetch the Requested Station Files

This example shows how you could construct a query using the `get_GSOD()` function. Be aware that it may result in incomplete data and error from the server if it stops responding. We've done our best to make _GSODR_ handle these errors, but if it does this, see the following option for using the `reformat_GSOD()` function.

```{r get_data, echo=TRUE, eval=TRUE}
PHL <- get_GSOD(station = 
                  eval(parse(text = loop_stations[, 12])), years = 1960:2015)
save(PHL, file = "IRRI_loop.RData")
```

## Another Option, Using `reformat_GSOD()`

_GSODR_ provides a function for dealing with local files that have been transferred from the server already as well, `reformat_GSOD()`. If the previous example with `get_GSOD()` does not work, this is a good alternative that takes a bit more intervention but gives the same results.

Using your FTP client (*e.g.*, FileZilla) log into the NCEI FTP server, [<ftp.ncdc.noaa.gov>](ftp.ncdc.noaa.gov) and navigate to /pub/data/gsod/.

## Using `reformat_GSOD()`

```{r reformat_GSOD, echo=TRUE, eval=FALSE}
years <- 1960:2015

loop_stations <- eval(parse(text = loop_stations[, 12]))

# create file list
loop_stations <- do.call(
  paste0, c(expand.grid(loop_stations, "-", years, ".op.gz"))
  )

local_files <- list.files(path = "./GSOD", full.names = TRUE, recursive = TRUE)
local_files <- local_files[basename(local_files) %in% loop_stations]

loop_data <- reformat_GSOD(file_list = local_files)

readr::write_csv(loop_data, file = "~/Loop_Survey_Weather_1960-2015")
```

## Examining the Data
```{r PHL_data}
PHL <- load(file = "IRRI_loop.Rdata")

library(dplyr)
PHL <-
  PHL %>%
  group_by(STN_NAME, YEAR) %>%
  summarise(ANNUAL_TEMP = mean(TEMP))

ggplot(data = PHL, aes(x = YEAR, y = ANNUAL_TEMP, group = 1)) +
  geom_line(aes(colour = STN_NAME)) +
  geom_point(aes(colour = STN_NAME)) +
  scale_colour_discrete(name  = "Station Name") +
  ylab("Mean Annual Temperature (˚C)") +
  facet_grid(STN_NAME ~ .)
```
